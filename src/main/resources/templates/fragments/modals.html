<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
</head>
<body>
    <!-- Modal de Mapa de Calor -->
    <div th:fragment="heatMapModal">
        <div id="heatMapModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
            <div class="relative max-h-[90vh] w-full max-w-4xl overflow-hidden rounded-2xl bg-white shadow-2xl">
                <!-- Header do Modal -->
                <div class="flex items-center justify-between border-b border-slate-200 bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-thermometer-half text-2xl text-white"></i>
                        <h3 class="text-xl font-bold text-white">Mapa de Calor - Ocupação dos Pátios</h3>
                    </div>
                    <button onclick="closeHeatMapModal()" class="rounded-full p-2 text-white transition hover:bg-white/20">
                        <i class="bi bi-x-lg text-xl"></i>
                    </button>
                </div>

                <!-- Conteúdo do Modal -->
                <div class="max-h-[calc(90vh-120px)] overflow-y-auto p-6">
                    <div class="mb-4 rounded-lg bg-blue-50 p-4">
                        <p class="text-sm text-blue-800">
                            <i class="bi bi-info-circle mr-2"></i>
                            Clique em um pátio para visualizar o mapa de calor detalhado
                        </p>
                    </div>

                    <div class="grid gap-4 sm:grid-cols-2" id="patiosListModal">
                        <!-- Os pátios serão carregados via JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <script>
            function openHeatMapModal() {
                loadPatiosData();
                const modal = document.getElementById('heatMapModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            }

            function closeHeatMapModal() {
                const modal = document.getElementById('heatMapModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = 'auto';
            }

            async function loadPatiosData() {
                try {
                    const response = await fetch('/api/patios/ocupacao');
                    const patios = await response.json();
                    renderPatiosList(patios);
                } catch (error) {
                    console.error('Erro ao carregar pátios:', error);
                    document.getElementById('patiosListModal').innerHTML = `
                        <div class="col-span-2 rounded-lg bg-red-50 p-4 text-center">
                            <p class="text-sm text-red-800">
                                <i class="bi bi-exclamation-triangle mr-2"></i>
                                Erro ao carregar dados dos pátios. Tente novamente.
                            </p>
                        </div>
                    `;
                }
            }

            function renderPatiosList(patios) {
                const container = document.getElementById('patiosListModal');
                if (!patios || patios.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-2 rounded-lg bg-slate-50 p-8 text-center">
                            <i class="bi bi-inbox text-4xl text-slate-400"></i>
                            <p class="mt-2 text-slate-600">Nenhum pátio cadastrado</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = patios.map(data => {
                    const percentual = data.percentual || 0;
                    const vagas = data.patio.capacidadeMaxima - data.ocupacao;
                    
                    let progressClass = 'bg-gradient-to-r from-green-400 to-green-500';
                    let badgeClass = 'bg-green-100 text-green-700';
                    
                    if (percentual >= 90) {
                        progressClass = 'bg-gradient-to-r from-red-500 to-red-600';
                        badgeClass = 'bg-red-100 text-red-700';
                    } else if (percentual >= 70) {
                        progressClass = 'bg-gradient-to-r from-orange-400 to-orange-500';
                        badgeClass = 'bg-orange-100 text-orange-700';
                    } else if (percentual >= 50) {
                        progressClass = 'bg-gradient-to-r from-yellow-400 to-yellow-500';
                        badgeClass = 'bg-yellow-100 text-yellow-700';
                    }

                    return `
                        <a href="/patios/${data.patio.id}/mapa"
                           class="group relative overflow-hidden rounded-xl border-2 border-slate-200 bg-white p-6 shadow-sm transition-all duration-200 hover:border-orange-400 hover:shadow-lg">
                            
                            <!-- Nome do Pátio -->
                            <div class="mb-4 flex items-start justify-between">
                                <div>
                                    <h4 class="text-lg font-bold text-slate-800">${data.patio.nome}</h4>
                                    <p class="text-sm text-slate-500">${data.patio.endereco || 'Sem endereço'}</p>
                                </div>
                                <i class="bi bi-building text-2xl text-slate-300 transition group-hover:text-orange-500"></i>
                            </div>

                            <!-- Barra de Progresso da Ocupação -->
                            <div class="mb-3">
                                <div class="mb-2 flex items-center justify-between text-xs font-semibold">
                                    <span class="text-slate-600">Ocupação</span>
                                    <span class="text-slate-700">${data.ocupacao} / ${data.patio.capacidadeMaxima}</span>
                                </div>
                                <div class="h-3 w-full overflow-hidden rounded-full bg-slate-100">
                                    <div style="width: ${percentual}%"
                                         class="${progressClass} h-full transition-all duration-500">
                                    </div>
                                </div>
                            </div>

                            <!-- Porcentagem -->
                            <div class="flex items-center justify-between">
                                <span class="${badgeClass} rounded-full px-3 py-1 text-sm font-bold">
                                    ${percentual.toFixed(1)}%
                                </span>
                                <span class="text-sm text-slate-600">
                                    ${vagas} vaga${vagas !== 1 ? 's' : ''}
                                </span>
                            </div>
                        </a>
                    `;
                }).join('');
            }

            // Fechar modal ao clicar fora
            document.getElementById('heatMapModal')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeHeatMapModal();
                }
            });

            // Fechar modal com ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeHeatMapModal();
                }
            });
        </script>
    </div>
</body>
</html>
